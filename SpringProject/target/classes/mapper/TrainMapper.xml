<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- CommentMapper.xml -->
<mapper namespace="mapper.TrainMapper">
	<cache />
	<resultMap type="Model.TrainStatinDTO" id="baseResultMap">
		<id column="STATION_CODE" jdbcType="VARCHAR" property="stationTimeCode" />
		<result column="STATION_NAME" jdbcType="VARCHAR" property="stationName" />
	</resultMap>
	<resultMap type="Model.TrainDTO" id="coustomListMap">
		<result column="TRAIN_CODE" jdbcType="BIGINT" property="trainCode" />
		<result column="SERVICE_DATE" jdbcType="VARCHAR" property="serviceDate" />
		<result column="TRAIN_NAME" jdbcType="VARCHAR" property="trainName" />
		<result column="TIME" jdbcType="VARCHAR" property="time" />
		<result column="STATION_NAME" jdbcType="VARCHAR" property="stationName" />
	</resultMap>
	<resultMap type="Model.TrainRegistrationDTO" id="infoListMap">
	<result column="TRAIN_REG_CODE" jdbcType="VARCHAR" property="trainRegCode"/>
	<result column="TRAIN_CODE" jdbcType="BIGINT" property="trainCode" />
	<result column="SEAT_NUM" jdbcType="VARCHAR" property="seatNum" />
	<result column="MEMBER_ID" jdbcType="VARCHAR" property="memberId" />
	<result column="DEPARTING_STATION" jdbcType="VARCHAR" property="departingStation" />
	<result column="ARRIVAL_STATION" jdbcType="VARCHAR" property="arrivalStation" />
	<result column="TRAIN_DATE" jdbcType="VARCHAR" property="trainDate" />
	<result column="TRAIN_PASSENGERS" jdbcType="VARCHAR" property="trainPassengers" />
	</resultMap>
	
	<select id="selectSearchStation" resultMap="baseResultMap">
		select
		STATION_NAME
		FROM
		TRAIN_STATION
	</select>
	<select id="selectCustomerTrain" resultMap="coustomListMap"
		parameterType="java.util.HashMap">

		select t.train_CODE,t.TRAIN_NAME,substr(xmlagg(xmlelement(a,',' ||
		st.time)order by st.time ).extract('//text()'),2) time from TRAIN t
		inner join
		station_time st on t.TRAIN_CODE = st.TRAIN_CODE inner join
		train_station ts on st.STATION_CODE = ts.STATION_CODE
		where
		<choose>
			<when test="station.size != 0">
				ts.STATION_NAME in
				<foreach collection="station" item="item" index="index"
					separator="," open="(" close=")">
					#{item}
				</foreach>
			</when>
		</choose>
		
	<choose>
			<when test="trainType.size != 0">
				and t.train_name in
				<foreach collection="trainType" item="item" index="index"
					separator="," open="(" close=")">
					#{item}
				</foreach>
				and
			</when>
		</choose>
	
		<![CDATA[ 
		to_date('00:00','HH24:MI')< to_date(st.time,'HH24:MI')]]>
		and
		<choose>
			<when test="station.size != 0">
				t.train_code in (select st.train_CODE from station_time st inner
				join
				train_station ts on st.STATION_CODE = ts.STATION_CODE
				where
				ts.STATION_NAME in
				<foreach collection="station" item="item" index="index"
					separator="," open="(" close=")">
					#{item}
				</foreach>
			</when>
		</choose>
		and t.train_name = 'KTX' and<![CDATA[ 
		to_date('00:00','HH24:MI')< to_date(st.time,'HH24:MI') ]]>group
		by st.train_CODE having count(*) >1 )
		group by t.train_CODE, t.TRAIN_NAME order by train_code ASC

	</select>
	
	
	<select id="selectTrainInfo" parameterType="java.util.HashMap" resultMap="infoListMap">
		select tr.TRAIN_CODE,tr.SEAT_NUM from
		 TRAIN_REGISTRATION tr join STATION_TIME st on tr.TRAIN_CODE = st.TRAIN_CODE join TRAIN_STATION ts 
		 on st.STATION_CODE = ts.STATION_CODE 
		where tr.TRAIN_CODE = #{trainCode} AND tr.TRAIN_DATE = TO_DATE(#{dateTrain}, 'yyyy-MM-dd') 
		and <![CDATA[ TO_DATE(#{sTime},'hh24:mi')<=TO_DATE(st.TIME,'hh24:mi') AND TO_DATE(#{eTime},'hh24:mi')>=TO_DATE(st.TIME,'hh24:mi') ]]>
		group by tr.TRAIN_CODE, tr.SEAT_NUM
	</select>
	
	
	<insert id="insertTrainTicket" parameterType="Model.TrainRegistrationDTO">
		INSERT INTO TRAIN_REGISTRATION (TRAIN_REG_CODE,TRAIN_CODE,SEAT_NUM,MEMBER_ID,DEPARTING_STATION,ARRIVAL_STATION,TRAIN_DATE,TRAIN_PASSENGERS) 
		VALUES ('A'||train_nn.NEXTVAL,#{trainCode},#{seatNum},#{memberId},#{departingStation},#{arrivalStation},#{trainDate},#{trainPassengers})

	</insert>
</mapper>